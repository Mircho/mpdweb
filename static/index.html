<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MPD WEB RADIO</title>

    <!-- Bootstrap -->
    <link href="resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="resources/css/sticky-footer-navbar.css" rel="stylesheet">
    <link href="resources/css/style.css" rel="stylesheet">
    <link href="resources/bmd/css/ripples.min.css" rel="stylesheet">
    <link href="resources/bmd/css/material-wfont.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  </head>
  <body>
    <!-- Begin page content -->
    <div id="mpdBody" class="container">
        <div class="row"  data-bind="allowBindings: initialized">
            <div class="page-header">
                <h1 data-bind="text:currentSongTitle">Current song</h1>
            </div>
            <div class="progress" data-bind="visible: mpdStatus.song.duration > 0">
                <div class="progress-bar progress-bar-striped" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%;">
                    <span class="sr-only">60% Complete</span>
                </div>
            </div>
        </div>
        <div class="row" data-bind="allowBindings: initialized">
            <div class="col-sm-8">

                <div id="controlPanel" class="panel panel-info">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-sm-10">
                            <ul class="nav navbar-nav">
                                <li>
                                    <!-- BUTTONS FOR THE PLAYER -->
                                    <button id="prevButton"
                                        type="button"
                                        class="btn btn-default btn-fab btn-raised mdi-av-skip-previous withripple"
                                        aria-playstate="prev"
                                        data-bind="click:changePlaybackState, enable: initialized">
                                    </button>
                                    <button id="playButton"
                                        type="button"
                                        class="btn btn-default btn-fab btn-raised mdi-av-play-arrow withripple"
                                        aria-playstate="toggle"
                                        data-bind="click:changePlaybackState, enable: initialized, css: playbackStatePlayButtonStyle">
                                    </button>
                                    <button id="nextButton"
                                        type="button"
                                        class="btn btn-default btn-fab btn-raised mdi-av-skip-next withripple"
                                        aria-playstate="next"
                                        data-bind="click:changePlaybackState, enable: initialized">
                                    </button>
                                    <!-- BUTTONS FOR THE PLAYER -->
                                </li>
                            </ul>
                            </div>
                        </div>
                        <div class="row">
                            <div class="slider" id="volumeSliderUI" data-bind="nouislider: volumeUI"></div>
                        </div>
                    </div>
                    <div class="panel-footer"><span data-bind="text: currentStateString"></span></div>
                </div>

                <div id="playlist" class="panel panel-info">
                    <div class="panel-heading">
                        <h3 class="panel-title">Playlist <span class="badge" data-bind="text:mpdCurrentPlaylist.items().length"></span></h3>
                        <span class="pull-right clickable" data-bind="click: addNewURI"><i class="glyphicon mdi-content-add"></i></span>
                        <span class="pull-right clickable" data-bind="click: savePlaylist"><i class="glyphicon mdi-content-save"></i></span>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="list-group" data-bind="foreach:mpdCurrentPlaylist.items">
                                <!-- PLAYLIST ITEM -->
                                <div class="list-group-item" data-bind="css: { active : isActive }, click: play">
                                    <h4>
                                        <span data-bind="text:displayName">Playlist item</span>
                                        <small class="pull-right">
                                                <button class="btn btn-mini" data-bind="click: remove, clickBubble: false">
                                                    <i class="mdi-content-remove-circle-outline"></i>
                                                </button>
                                        </small>
                                    </h4>
                                    <small data-bind="text:description">
                                        Station name
                                    </small>
                                </div>
                                <!-- PLAYLIST ITEM -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="fileListPanel" class="col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <input id="fileSearch"
                                type="text"
                                class="form-control"
                                placeholder="Search for file"
                                data-hint="Sarch for song"
                                data-bind="textInput: searchString">
                        </h3>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="list-group">
                                <div class="list-group-item" data-bind="visible:dbPath()!='', click:goOneStepBackInPath">
                                        <i class="mdi-navigation-arrow-back"></i>
                                        <span>Back</span>
                                </div>
                                <!-- ko foreach: dbItemsPlaylistsRemoved -->
                                <div class="list-group-item" data-bind="css:'item-'+type(), click:openItem">
                                        <i class="mdi-file-folder"></i>
                                        <i class="mdi-content-add-circle-outline"></i>
                                        <span data-bind="text:displayName"></span>
                                </div>
                                <!-- /ko -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Playlists <span class="badge" data-bind="text:mpdPlaylists.items().length"></span></h3>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="list-group" data-bind="foreach:mpdPlaylists.items">
                                <div class="list-group-item" data-bind="click: load">
                                    <div>
                                        <span data-bind="text:title">Playlist item</span>
                                        <small class="pull-right">
                                                <button class="btn btn-mini" data-bind="click: remove, clickBubble: false">
                                                    <i class="mdi-content-remove-circle-outline"></i>
                                                </button>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    </div>

    </div>

    <div class="footer">
        <div class="container">
            <p class="text-muted">MPD Web Radio player</p>
        </div>
    </div>

    <!-- TEMPLATE FOR REMOVE DIALOG -->
    <script type="text/html" id="mpdradioRemoveSongModalTemplate">
    <div class="modal fade" id="mpdradioRemoveModal" tabindex="-1" role="dialog" aria-labelledby="mpdradioRemoveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Remove</h4>
                </div>
                <div class="modal-body" data-bind="text: song.displayName"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: remove">Remove</button>
                    <button type="button" class="btn" data-dismiss="modal" data-bind="click: cancel">Close</button>
                </div>
            </div>
        </div>
    </div>
    </script>
    <!-- TEMPLATE FOR REMOVE DIALOG -->

    <!-- TEMPLATE FOR ADD URI DIALOG -->
    <script type="text/html" id="mpdradioAddSongModalTemplate">
    <div class="modal fade" id="mpdradioAddModal" tabindex="-1" role="dialog" aria-labelledby="mpdradioAddModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Add</h4>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" placeholder="enter URI to add to the playlist" aria-describedby="basic-addon2" data-bind="textInput: newURI">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: add">Add</button>
                    <button type="button" class="btn" data-dismiss="modal" data-bind="click: cancel">Close</button>
                </div>
            </div>
        </div>
    </div>
    </script>
    <!-- TEMPLATE FOR ADD URI DIALOG -->

    <!-- TEMPLATE FOR REMOVE PLAYLIST DIALOG -->
    <script type="text/html" id="mpdradioRemovePlaylistModalTemplate">
    <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mpdradioRemovePlaylistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Remove a playlist</h4>
                </div>
                <div class="modal-body" data-bind="text: playlist.title"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: remove">Remove</button>
                    <button type="button" class="btn" data-dismiss="modal" data-bind="click: cancel">Close</button>
                </div>
            </div>
        </div>
    </div>
    </script>
    <!-- TEMPLATE FOR REMOVE PLAYLIST DIALOG -->

    <!-- TEMPLATE FOR SAVE PLAYLIST DIALOG -->
    <script type="text/html" id="mpdradioSavePlaylistModalTemplate">
    <div class="modal fade" id="mpdradioSavePlaylistModal" tabindex="-1" role="dialog" aria-labelledby="mpdradioSavePlaylistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Save playlist</h4>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" placeholder="enter name of the playlist" aria-describedby="basic-addon2" data-bind="textInput: playlistName">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: save">Save</button>
                    <button type="button" class="btn" data-dismiss="modal" data-bind="click: cancel">Close</button>
                </div>
            </div>
        </div>
    </div>
    </script>
    <!-- TEMPLATE FOR SAVE PLAYLIST DIALOG -->



    <script src="resources/js/jquery-1.11.1.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="resources/bootstrap/js/bootstrap.min.js"></script>
    <script src="resources/bmd/js/ripples.min.js"></script>
    <script src="resources/bmd/js/material.min.js"></script>
    <script src="resources/js/knockout-3.2.0.js"></script>
    <script src="resources/js/knockout.mapping-latest.debug.js"></script>
    <script src="resources/js/knockout.merge.js"></script>
    <script src="resources/js/ko.editables.js"></script>
    <script src="resources/js/knockstrap.js"></script>
    <script src="resources/bmd/js/jquery.nouislider.all.js"></script>
    <script src="resources/bmd/js/jquery.liblink.js"></script>
    <script>
        ko.observable.fn.withPausing = function() {
            this.notifySubscribers = function() {
                if (!this.pauseNotifications) {
                    ko.subscribable.fn.notifySubscribers.apply(this, arguments);
                }
            };

            this.quietUpdate = function(newValue) {
                this.pauseNotifications = true;
                this( newValue );
                this.pauseNotifications = false;
            };

            return this;
        };

        ko.bindingHandlers.allowBindings = {
            init :    function( element, valueAccessor )
                    {
                        // Let bindings proceed as normal *only if* my value is false
                        var shouldAllowBindings = ko.utils.unwrapObservable( valueAccessor() );
                        return { controlsDescendantBindings: !shouldAllowBindings };
                    },
            update : function( element, valueAccessor, allBindings, viewModel, bindingContext )
                     {
                        var shouldAllowBindings = ko.utils.unwrapObservable( valueAccessor() );
                        if( shouldAllowBindings )
                        {
                            //console.log( element );
                            //ko.cleanNode( element );
                            ko.applyBindingsToDescendants( bindingContext, element );
                        }
                        return { controlsDescendantBindings: !shouldAllowBindings };
                     }
        };

        ko.bindingHandlers.nouislider = {
            init :      function( element, valueAccessor, allBindingsAccessor )
                        {
                            var observable = valueAccessor();
                            ko.utils.registerEventHandler( element, "change",
                                function()
                                {
                                    observable( Math.floor( $( element ).val() ) );
                                }
                            );

                            //this is wrong, we want the initiall value to come from the model not vice versa
                            //observable( Math.floor( $( element ).val() ) );

                            ko.utils.domNodeDisposal.addDisposeCallback( element,
                                function()
                                {

                                }
                            );
                        },
            update :    function( element, valueAccessor, allBindingsAccessor )
                        {
                            var value = ko.utils.unwrapObservable( valueAccessor() );
                            $( element ).val( value );
                        }
        };

        /**
         * Original article
         * http://aboutcode.net/2012/11/15/twitter-bootstrap-modals-and-knockoutjs.html
         **/
        function showModal( options )
        {
            var viewModel = options.viewModel;
            var template = options.template || viewModel.template;
            var context = options.context;
            return __createModalElement( template, viewModel )
                    .pipe( $ )
                    .pipe(
                            function( $ui )
                            {
                                var deferredModalResult = $.Deferred();
                                viewModel.modal = {
                                    close : function( result )
                                            {
                                                if( typeof result != 'undefined' )
                                                {
                                                    deferredModalResult.resolveWith( context, [result] )
                                                }
                                                else
                                                {
                                                    deferredModalResult.rejectWith( context, [] );
                                                }
                                            }
                                };
                                $ui.modal();
                                $ui.on( 'hidden',
                                    function()
                                    {
                                        $ui.each(
                                            function ( index, element )
                                            {
                                                ko.cleanNode( element );
                                            }
                                        );
                                        $ui.remove();
                                    }
                                );
                                deferredModalResult.always(
                                    function()
                                    {
                                        $ui.modal( 'hide' );
                                    }
                                );
                                return deferredModalResult;
                            }
                         );

        }
        function __createModalElement( templateName, viewModel )
        {
            var tempDiv = document.createElement( 'DIV' );
            tempDiv.style.display = 'none';
            document.body.appendChild( tempDiv );

            var deferredElement = $.Deferred();

            ko.renderTemplate(
                templateName,
                viewModel,
                {
                    afterRender :   function( nodes )
                                    {
                                        var elements = nodes.filter(
                                            function( node )
                                            {
                                                return node.nodeType === 1;
                                            }
                                        );
                                        deferredElement.resolve( elements[ 0 ] );
                                    }
                },
                tempDiv,
                "replaceNode"
            );

            return deferredElement;
        }

        ko.extenders.loadRemote = function ( destination, options )
        {
            var mapping = ( !!options.mapping ) ? options.mapping : {};
            var dataFilter = options.dataFilter;
            var viewModel = ( !!options.viewModel ) ? options.viewModel : {};

            var remoteURL;
            if( ko.isComputed( options.url ) )
            {
                remoteURL = options.url;
            }
            else
            {
                remoteURL = ko.observable( options.url );
            }

            remoteURL.subscribe(
                function( newValue )
                {
                    viewModel.refresh( true );
                }
            )

            viewModel.loading = ko.observable( false );
            viewModel.loaded = ko.observable( false );
            var remoteCall;
            viewModel.refresh = ko.pureComputed(
                {
                    read : function()
                    {
                        return this.loading();
                    },
                    write : function( newValue )
                    {
                        viewModel.loading( true );
                        viewModel.loaded( false );
                        remoteCall = $.ajax( {
                            url         : remoteURL(),
                            dataType     : "json"
                        } )
                        .done(
                            function( data )
                            {
                                if( dataFilter && data[ dataFilter ] )
                                {
                                    data = data[ dataFilter ];
                                }
                                ko.mapping.fromJS( data, mapping, viewModel );
                                viewModel.loaded( true );
                            }
                        )
                        .always(
                            function()
                            {
                                viewModel.loading( false );
                                remoteCall = null;
                            }
                        );
                    },
                    owner : viewModel
                }
            );
            viewModel.cancel = ko.pureComputed(
                {
                    read : function()
                    {
                        return remoteCall;
                    },
                    write : function( value )
                    {
                        if( remoteCall )
                        {
                            remoteCall.abort();
                        }
                    }
                }
            );
            return viewModel;
        }
    </script>
    <script>
        /* some links:
         * http://knockoutjs.com/documentation/throttle-extender.html
         * http://www.freshblurbs.com/blog/2012/05/09/async-data-loading-knockout-js-without-callback-hell.html
         * https://github.com/knockout/knockout/wiki/asynchronous-dependent-observables
         *
         */

        var WS_ADDRESS = "ws://radio.kafka.linux-bg.org/ws/";
        var BASE_ADDRESS = "http://radio.kafka.linux-bg.org";
        var STATUS_ADDRESS = BASE_ADDRESS +       "/api/mpd/status";
        var PLAYLIST_ADDRESS = BASE_ADDRESS +     "/api/mpd/playlist";
        var PLAYLISTS_ADDRESS = BASE_ADDRESS +     "/api/mpd/playlists";
        var PLAY_SONG_ADDRESS = BASE_ADDRESS +    "/api/mpd/play";

        var REMOVE_SONG_ADDRESS = BASE_ADDRESS +  "/api/mpd/song";
        var ADD_SONG_ADDRESS = BASE_ADDRESS +     "/api/mpd/song";

        var CHANGE_STATE_ADDRESS = BASE_ADDRESS + "/api/mpd/state";
        var CHANGE_VOLUME_ADDRESS = BASE_ADDRESS + "/api/mpd/volume";
        var DB_BROWSE_ADDRESS = BASE_ADDRESS + "/api/mpd/browse";
        var DB_SEARCH_ADDRESS = BASE_ADDRESS + "/api/mpd/search";

        var mpdLSong =     function( songData )
        {
            var self = this;
            if( songData )
            {
                ko.mapping.fromJS( songData, {}, this );
            }
            this.isRadio = ko.computed(
                function()
                {
                    if( this.uri().indexOf( 'http' ) == 0 )
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }
                },
                self,
                {
                    deferEvaluation : true
                }
            );
            this.displayName = ko.computed(
                function()
                {
                    var displayName = '';
                    if( this.isRadio() )
                    {
                        //this is a radio
                        if( this.isActive() )
                        {
                            displayName = this.title() || this.stream() || this.uri();
                        }
                        else
                        {
                            displayName = this.stream() || this.uri();
                        }
                    }
                    else
                    {
                        if( this.title().length > 0 )
                        {
                            displayName = this.title();
                        }
                        else
                        {
                            displayName = this.uri().split("/").pop().split( "." )[0];
                        }
                    }

                    return displayName;
                },
                self,
                {
                    deferEvaluation : true
                }
            );
            this.description = ko.computed(
                function()
                {
                    var description = '';

                    if( this.uri().indexOf( 'http' ) == 0 )
                    {
                        description =  this.isActive() ? this.stream() : "";
                    }
                    else
                    {
                        if( this.artist() )
                        {
                            description = this.artist() + ', ';
                        }
                        description += this.album();
                    }

                    return description;
                },
                self,
                {
                    deferEvaluation : true
                }
            );
            this.isActive = ko.computed(
                function()
                {
                    if( this.rootVM && this.rootVM.mpdStatus && this.rootVM.mpdStatus.loaded() )
                    {
                        if( !this.id ) return false;
                        return this.id() == this.rootVM.mpdStatus.song.id();
                    }
                    else
                    {
                        return false;
                    }
                },
                self,
                {
                    deferEvaluation : true
                }
            );
            this.play = function()
            {
                this.rootVM.playSong( this );
            };
            this.remove = function( song, event )
            {
                this.rootVM.removeSong( this );
            }
        }
        function PlayListViewModel( parentModel )
        {
            this.parentVM = parentModel;
            this.items = ko.mapping.fromJS( [] );
        }

        var playlistMapping = {
            'items' :    {
                            create :    function( options )
                                        {
                                            var playlistSong = ko.mapping.fromJS( options.data, {}, new mpdLSong() );
                                            playlistSong.parentVM = options.parent;
                                            playlistSong.rootVM = options.parent.parentVM || options.parentVM;
                                            return playlistSong;
                                        },
                        }
        };

        function playListItem( playlistData )
        {
            var self = this;
            if( playlistData )
            {
                ko.mapping.fromJS( playlistData, {}, this );
            }
            this.remove = function( playlist, event )
            {
                this.rootVM.removePlaylist( this );
            }
            this.load = function( playlist, event )
            {
                this.rootVM.loadPlaylist( this );
            }
        }

        function PlayListsViewModel( parentModel )
        {
            this.parentVM = parentModel;
            this.items = ko.mapping.fromJS( [] );
        }

        var playlistsMapping = {
            'items' :    {
                            create :    function( options )
                                        {
                                            var playlistsItem = ko.mapping.fromJS( options.data, {}, new playListItem() );
                                            playlistsItem.parentVM = options.parent;
                                            playlistsItem.rootVM = options.parent.parentVM || options.parentVM;
                                            return playlistsItem;
                                        },
                        }
        };

        var statusMapping = {
            'song' :    {
                            create :    function( options )
                                        {
                                            var currentSong;
                                            if( options.data )
                                            {
                                                currentSong = ko.mapping.fromJS( options.data, {}, new mpdLSong() );
                                            }
                                            else
                                            {
                                                currentSong = new mpdLSong();
                                                currentSong.title = ko.observable( "Not available" );
                                                currentSong.duration = ko.observable( 0 );
                                                currentSong.id = ko.observable( -1 );
                                            }
                                            currentSong.rootVM = options.parent;
                                            return currentSong;
                                        }

                        },
        };

        var dbItem =     function( dbItemData )
        {
            var self = this;
            this.path = ko.observable();
            this.title = ko.observable();
            if( dbItemData )
            {
                ko.mapping.fromJS( dbItemData, {}, this );
            }
            this.displayName = ko.computed(
                function()
                {
                    var name;
                    if( this.title() )
                    {
                        return this.title();
                    }
                    else if( this.path() )
                    {
                        name = this.path();
                        if( name.lastIndexOf( '/' ) >= 0 )
                        {
                            name = name.substr( name.lastIndexOf( '/' ) + 1, name.length - 1 );
                        }
                        return name;
                    }
                    else if( this.uri() )
                    {
                        name = this.uri();
                        if( name.lastIndexOf( '/' ) >= 0 )
                        {
                            name = name.substr( name.lastIndexOf( '/' ) + 1, name.length - 1 );
                        }
                        return name;
                    }
                },
                self,
                {
                    deferEvaluation : true
                }
            );
            this.openItem = function()
            {
                if( self.type() == 'DIR' )
                {
                    self.rootVM.dbPath( self.path() );
                }
                else if( self.type() == 'SONG' )
                {
                    self.rootVM.addSongToPlaylist( self.uri() );
                }
            }
        }

        function dbItemViewModel( parentModel )
        {
            this.parentVM = parentModel;
            this.items = ko.mapping.fromJS( [] );
        }

        var dbItemsMapping = {
            'items' :    {
                            create :    function( options )
                                        {
                                            var _dbItem = ko.mapping.fromJS( options.data, {}, new dbItem() );
                                            _dbItem.parentVM = options.parent;
                                            _dbItem.rootVM = options.parent.parentVM || options.parentVM;
                                            return _dbItem;
                                        },
                        }
        };

        /**
         * Define the VM here
         *
         **/

        function MPDStateVM()
        {
            var self = this;
            this.serverWSMessage = ko.observable().extend( { notify : 'always', rateLimit: 100 } );
            this.initialized = ko.observable( false );

            this.searchString = ko.observable().extend( { rateLimit: { timeout: 500, method: "notifyWhenChangesStop" } } );

            this.dbPath = ko.observable( '' );
            this.calculatedDbPath = ko.computed(
                function()
                {
                    var newPath = DB_BROWSE_ADDRESS+'?path='+this.dbPath();
                    console.log( 'I am prase, schweine, pig, fat feet! I stink! I munch! I belch and blurp!', newPath );
                    if( this.searchString() )
                    {
                        newPath = DB_SEARCH_ADDRESS+'?search='+this.searchString();
                    }
                    return newPath;
                },
                self
            );

            this.mpdStatus = ko.observable().extend(
                {
                    loadRemote: {
                                    url: STATUS_ADDRESS,
                                    mapping: statusMapping,
                                    viewModel : {
                                                    loaded : ko.observable( false )
                                                }
                                }
                }
            );

            this.mpdPlaylists = ko.observableArray( [] ).extend(
                {
                    loadRemote: {
                                    url: PLAYLISTS_ADDRESS,
                                    mapping: playlistsMapping,
                                    viewModel: new PlayListsViewModel( self )
                                }
                }
            );

            this.mpdCurrentPlaylist = ko.observable().extend(
                {
                    loadRemote: {
                                    url: PLAYLIST_ADDRESS,
                                    mapping: playlistMapping,
                                    viewModel: new PlayListViewModel( self )
                                }
                }
            );

            this.dbItems = ko.observable().extend(
                {
                    loadRemote: {
                                    url: self.calculatedDbPath,
                                    mapping: dbItemsMapping,
                                    viewModel: new dbItemViewModel( self )
                                }
                }
            );

            this.dbItemsPlaylistsRemoved = ko.computed(
                function()
                {
                    return ko.utils.arrayFilter(
                        this.dbItems.items(),
                        function( item )
                        {
                            return item.type() != 'LIST';
                        }
                    );
                },
                self
            )
        }

        var mpdState = new MPDStateVM();

        mpdState.mpdStatus.loaded.subscribe(
            function( newValue )
            {
                console.log( 'Status loaded: ', newValue );
                if( newValue && !this.initialized() )
                {
                    console.log( 'Initialized set to true' );
                    this.initialized( true );
                }
            },
            mpdState
        );

        mpdState.goOneStepBackInPath = function()
        {
            console.log( 'following the path back', this.dbPath() );
            var path = this.dbPath();
            if( path.length > 0 )
            {
                if( path.indexOf( '/' ) >= 0 )
                {
                    path = path.substr( 0, path.indexOf( '/' ) - 1 );
                }
                else
                {
                    path = '';
                }
                console.log( 'going back to path', path );
                this.dbPath( path );
            }
            else
            {
            }
        }

        mpdState.playbackStateUI = ko.pureComputed(
            {
                owner : mpdState,
                deferEvaluation : true,
                read : function()
                {
                    return this.mpdStatus.state();
                },
                write : function( newState )
                {
                    jQuery.post(
                        CHANGE_STATE_ADDRESS,
                        {
                            'state' : newState
                        }
                    );
                }
            }
        )

        mpdState.changePlaybackState = function( data, event )
        {
            var state = event.currentTarget.getAttribute( 'aria-playstate' );
            if( state == 'toggle' )
            {
                var toggleMap = {
                    'play' : 'pause',
                    'stop' : 'play',
                    'pause' : 'play'
                };
                state = toggleMap[ this.mpdStatus.state().toLocaleLowerCase() ];
            }
            this.playbackStateUI( state );
        }

        mpdState.currentStateString = ko.pureComputed(
            function()
            {
                var stateClassMap = {
                    'play' : 'Playing',
                    'stop' : 'Stopped',
                    'pause' : 'Paused'
                };
                var currentState = this.mpdStatus.state().toLowerCase();
                return stateClassMap[ currentState ];
            },
            mpdState
        )

        mpdState.playbackStatePlayButtonStyle = ko.pureComputed(
            function()
            {
                var stateClassMap = {
                    'play' : 'mdi-av-play-arrow',
                    'stop' : 'mdi-av-stop',
                    'pause' : 'mdi-av-pause'
                };
                var currentState = this.mpdStatus.state().toLowerCase();
                return stateClassMap[ currentState ];
            },
            mpdState
        )

        mpdState.currentSongTitle = ko.pureComputed(
            function()
            {
                var statusSong = this.mpdStatus.song;
                //return this.mpdStatus.song.title() || this.mpdStatus.song.stream();
                return statusSong.title() || statusSong.stream();
            },
            mpdState,
            {
                deferEvaluation: true
            }
        )

        mpdState.volumeUI = ko.pureComputed(
            {
                owner : mpdState,
                deferEvaluation : true,
                read : function()
                {
                    return this.mpdStatus.volume();
                },
                write : function( newValue )
                {
                    jQuery.post(
                        CHANGE_VOLUME_ADDRESS,
                        {
                            'value' : newValue
                        }
                    );
                }
            }
        )

        ko.computed(
            function()
            {
                var wsmessage = mpdState.serverWSMessage();
                console.log( 'WebSocket Message: ', wsmessage );
                switch( wsmessage )
                {
                    case "connected"    :
                    case "CONNECT"      :
                                            this.mpdCurrentPlaylist.refresh( true );
                                            this.mpdStatus.refresh( true );
                                            this.mpdPlaylists.refresh( true );
                                            this.dbItems.refresh( true );
                                            break;

                    case "disconnected" :
                    case "DISCONNECT"   :   mpdState.initialized( false );
                                            break;

                    case "player" :
                    case "mixer" :          console.log( 'player change received' );
                                            this.mpdStatus.refresh( true );
                                            break;

                    case "playlist" :       this.mpdCurrentPlaylist.refresh( true );
                                            this.mpdStatus.refresh( true );
                                            break;

                    case "stored_playlist" :this.mpdPlaylists.refresh( true );
                                            break;
                }
            },
            mpdState
        );

        mpdState.playSong = function( song )
        {
            jQuery.post(
                PLAY_SONG_ADDRESS,
                {
                    id : song.id()
                }
            );
        }

        mpdState.removeSong = function( song )
        {
            showModal(
                {
                    viewModel: new SongEditViewModel( song ),
                    context: this
                }
            ).done(
                function( song )
                {
                    jQuery.ajax(
                        {
                            url : REMOVE_SONG_ADDRESS + '/' + song.pos(),
                            type : 'DELETE'
                        }
                    );
                }
            ).fail(
                function()
                {
                }
            );
        }

        var SongEditViewModel = function( song )
        {
            this.song = song;
        }
        SongEditViewModel.prototype.template = 'mpdradioRemoveSongModalTemplate';
        SongEditViewModel.prototype.cancel = function()
        {
            this.modal.close();
        };
        SongEditViewModel.prototype.remove = function()
        {
            this.modal.close( this.song );
        };

        mpdState.addNewURI = function( data, event )
        {
            showModal(
                {
                    viewModel: new AddURIViewModel(),
                    context: this
                }
            ).done(
                function( uri )
                {
                    jQuery.post(
                        ADD_SONG_ADDRESS,
                        {
                            uri : uri()
                        }
                    ).done(
                        function( data )
                        {
                        }
                    );
                }
            ).fail(
                function()
                {
                }
            );
        }

        var AddURIViewModel = function()
        {
            this.newURI = ko.observable( '' );
        }
        AddURIViewModel.prototype.template = 'mpdradioAddSongModalTemplate';
        AddURIViewModel.prototype.cancel = function()
        {
            this.modal.close();
        };
        AddURIViewModel.prototype.add = function()
        {
            this.modal.close( this.newURI );
        };

        mpdState.savePlaylist = function( data, event )
        {
            showModal(
                {
                    viewModel: new SavePlaylistViewModel(),
                    context: this
                }
            ).done(
                function( playlistName )
                {
                    jQuery.post(
                        PLAYLIST_ADDRESS + '/' + playlistName()
                    ).done(
                        function( data )
                        {
                        }
                    );
                }
            ).fail(
                function()
                {
                }
            );
        }

        var SavePlaylistViewModel = function()
        {
            this.playlistName = ko.observable( '' );
        }
        SavePlaylistViewModel.prototype.template = 'mpdradioSavePlaylistModalTemplate';
        SavePlaylistViewModel.prototype.cancel = function()
        {
            this.modal.close();
        };
        SavePlaylistViewModel.prototype.save = function()
        {
            this.modal.close( this.playlistName );
        };

        mpdState.removePlaylist = function( song )
        {
            showModal(
                {
                    viewModel: new PlaylistEditViewModel( song ),
                    context: this
                }
            ).done(
                function( playlist )
                {
                    jQuery.ajax(
                        {
                            url : PLAYLISTS_ADDRESS + '/' + playlist.title(),
                            type : 'DELETE'
                        }
                    );
                }
            ).fail(
                function()
                {
                }
            );
        }

        var PlaylistEditViewModel = function( playlist )
        {
            this.playlist = playlist;
        }
        PlaylistEditViewModel.prototype.template = 'mpdradioRemovePlaylistModalTemplate';
        PlaylistEditViewModel.prototype.cancel = function()
        {
            this.modal.close();
        };
        PlaylistEditViewModel.prototype.remove = function()
        {
            this.modal.close( this.playlist );
        };

        mpdState.loadPlaylist = function( playlist )
        {
            jQuery.ajax(
                {
                    url : PLAYLISTS_ADDRESS + '/' + playlist.title(),
                    type : 'GET'
                }
            );
        }

        mpdState.addSongToPlaylist = function( songURI )
        {
            jQuery.post(
                ADD_SONG_ADDRESS,
                {
                    uri : songURI
                }
            ).done(
                function( data )
                {
                }
            );
        }

        var WS = {
            CONFIG : {
                RECONNECT_DELAY : 1000,
                KEEPALIVE_DELAY : 5000,
            },
            ws : null,
            kaHandle : null,
            keepAlive:  function()
                        {
                            var self = this;
                            self.ws.send( 'PING' );
                            this.kaHandle = setTimeout( function() { self.keepAlive() }, this.CONFIG.KEEPALIVE_DELAY );
                        },
            connect :   function()
                        {
                            console.log( 'Connecting to server... ', WS_ADDRESS );
                            var self = this;
                            this.ws = new window.WebSocket( WS_ADDRESS );
                            this.ws.onopen = function( event )
                            {
                                mpdState.serverWSMessage( 'connected' );
                                self.keepAlive();
                            }
                            this.ws.onclose = function( event )
                            {
                                clearTimeout( self.kaHandle );
                                mpdState.serverWSMessage( 'diconnected' );
                                console.log( "Connection closed. Need to reopen in " + self.CONFIG.RECONNECT_DELAY + " msec" );
                                setTimeout( function(){ self.connect(); }, self.CONFIG.RECONNECT_DELAY );
                            }
                            this.ws.onmessage = function( event )
                            {
                                mpdState.serverWSMessage( event.data );
                            }
                            window.addEventListener( 'beforeunload',
                                    function()
                                    {
                                        clearTimeout( self.kaHandle );
                                        self.ws.onclose = function(){};
                                        self.ws.close();
                                    }
                            );
                        }
        }

        jQuery(
            function()
            {
                //init material design scripts
                $.material.init();

                $( '#volumeSliderUI' ).noUiSlider({
                    start: 0,
                    step: 1,
                    connect: "lower",
                    range: {
                        min: 0,
                        max: 100
                    },
                    animate: true
                });
                $( '#volumeSliderUI' ).Link( 'lower' )
                .to(
                    '-inline-<div class="tooltip"></div>',
                    function( value )
                    {
                        value = Math.floor( value );
                        $(this).html(
                            //'<strong>Volume: </strong>' +
                            '<span>' + value + '%</span>'
                        );
                    }
                );

                WS.connect();

                ko.applyBindings( mpdState, $( '#mpdBody' ).get(0) );
            }
        )
    </script>
</body>
</html>
